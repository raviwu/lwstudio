<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>在 Trailblazer 的 Policy 中透過客制 Exception 來處理複雜的「錯誤回應」 - Ravi Wu</title><link rel="icon" type="image/png" href=favicon.ico /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="在 Trailblazer 的 Policy 中透過客制 Exception 來處理複雜的「錯誤回應」" />
<meta property="og:description" content="為了盡量貼近 Trailblazer 的設計概念，許多原先會透過 Controller before_action 去處理的權限管控，盡量都搬進 Trailblazer 的 Policy 裡。
Policy 採用類似 Pundit 的語法，典型的 Policy 如下：
class Thing::Policy def initialize(user, thing) @user, @thing = user, thing end def create?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://raviwu.github.io/posts/customize-error-handlement-in-trailblazer-policy/" />
<meta property="article:published_time" content="2017-01-14T13:25:31+08:00" />
<meta property="article:modified_time" content="2017-01-14T13:25:31+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="在 Trailblazer 的 Policy 中透過客制 Exception 來處理複雜的「錯誤回應」"/>
<meta name="twitter:description" content="為了盡量貼近 Trailblazer 的設計概念，許多原先會透過 Controller before_action 去處理的權限管控，盡量都搬進 Trailblazer 的 Policy 裡。
Policy 採用類似 Pundit 的語法，典型的 Policy 如下：
class Thing::Policy def initialize(user, thing) @user, @thing = user, thing end def create?"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://raviwu.github.io/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://raviwu.github.io/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://raviwu.github.io/css/custom.css" />
	<link rel="stylesheet" type="text/css" href="https://raviwu.github.io/css/dark.css"  />
	<link rel="stylesheet" type="text/css" href="https://raviwu.github.io/css/custom-dark.css"  />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://raviwu.github.io/js/main.js"></script>
	<script src="https://raviwu.github.io/js/abc.js"></script>
	<script src="https://raviwu.github.io/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://raviwu.github.io/">
	<h1 class="site-title"><a href="https://raviwu.github.io/">Ravi Wu</a></h1>
	<div class="site-description"><h2>random thoughts and notes, beware if you want to reference</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/raviwu" title="Github"><i data-feather="github"></i></a><a href="https://www.linkedin.com/in/raviwu/" title="Linkedin"><i data-feather="linkedin"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">在 Trailblazer 的 Policy 中透過客制 Exception 來處理複雜的「錯誤回應」</h1>
			<div class="meta">Posted at &mdash; Jan 14, 2017</div>
		</div>

		<div class="markdown">
			<p>為了盡量貼近 Trailblazer 的設計概念，許多原先會透過 Controller <code>before_action</code> 去處理的權限管控，盡量都搬進 Trailblazer 的 <a href="http://trailblazer.to/gems/operation/1.1/policy.html">Policy</a> 裡。</p>
<p>Policy 採用類似 <a href="https://github.com/elabs/pundit">Pundit</a> 的語法，典型的 Policy 如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">class</span> <span style="color:#268bd2">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Policy</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(user, thing)
    @user, @thing <span style="color:#719e07">=</span> user, thing
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">create?</span>
    (admin? <span style="color:#719e07">||</span> approved?) <span style="color:#719e07">&amp;&amp;</span> @thing<span style="color:#719e07">.</span>persisted?
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">private</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">admin?</span>
    @user<span style="color:#719e07">.</span>admin <span style="color:#719e07">==</span> <span style="color:#719e07">true</span>
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">approved?</span>
    @user<span style="color:#719e07">.</span>is_approved
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>在 Operation 中若要調用這隻 Policy 的話要宣告：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">class</span> <span style="color:#268bd2">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Create</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">Trailblazer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Operation</span>
    builds <span style="color:#719e07">-&gt;</span> (params) { dispatched_class_accroding_to(params) }

    <span style="color:#719e07">def</span> <span style="color:#268bd2">self</span><span style="color:#719e07">.</span><span style="color:#268bd2">dispatched_class_accroding_to</span>(params)
    <span style="color:#cb4b16">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Create</span>
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">include</span> <span style="color:#cb4b16">Trailblazer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Operation</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Policy</span>
    policy <span style="color:#cb4b16">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Policy</span>, <span style="color:#2aa198">:create?</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">process</span>(params)
    validate(params<span style="color:#719e07">[</span><span style="color:#2aa198">:thing</span><span style="color:#719e07">]</span>) <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>f<span style="color:#719e07">|</span>
        f<span style="color:#719e07">.</span>save
    <span style="color:#719e07">end</span>
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>Operation 在 controller 裡被 <code>call</code> 的時候，會先跑 <code>builds</code> 去回傳 Operation 類別，此時，正是個機會去依照 params 內容 dispatch 到其他的 Operation 去，改天再分享利用 <code>builds</code> 簡化路由的實作。</p>
<p>透過 builds 確認 operation 後，所有的參數會先經過 <code>setup!(params)</code> &gt; <code>setup_params!(params)</code> &gt; <code>model!(params)</code> &gt; <code>setup_model!</code> 等 operation 的 method 去建立這隻 operation 操作所需的背景條件（基本上都是要依照條件去撈 model 出來，或是要對參數做前處理等，詳細 callstack 請參考這個<a href="http://trailblazer.to/gems/operation/1.1/api.html">頁面</a>），跑完整個 setup 的過程後，如果有指定 Policy 才會送進 Policy 的對應 method 裡。</p>
<p>Policy initialize 裡的 <code>user</code> 跟 <code>thing</code> 對應到 <code>params[:current_user]</code> 跟 <code>operation.model</code> 這兩個物件，前述的 <code>params[:current_user]</code> 如果跑完 <code>setup!(params)</code> &gt; <code>setup_params!(params)</code> &gt; <code>model!(params)</code> &gt; <code>setup_model!</code> 都沒有指定的話會預設 <code>nil</code> 值，而 <code>operation.model</code> 則是 <code>model!(params)</code> &gt; <code>setup_model!</code> 中所指定的 resource。如果 <code>user</code> / <code>thing</code> 的狀態在 <code>Thing::Policy#create?</code> 裡的運算結果為 <code>true</code> 時，才會繼續送到 <code>process(params)</code> 的方法中繼續處理，不然就會丟 <code>Trailblazer::NotAuthorizedError</code> 例外。</p>
<p>問題來了，在 controller 裡面，案例給的很乾淨：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">class</span> <span style="color:#268bd2">CommentsController</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationController</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">create</span>
    run <span style="color:#cb4b16">Comment</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Create</span> <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>op<span style="color:#719e07">|</span>
        flash<span style="color:#719e07">[</span><span style="color:#2aa198">:notice</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Success!&#34;</span> <span style="color:#586e75"># only run for successful/valid operation.</span>
        <span style="color:#719e07">return</span> redirect_to thing_path(@model<span style="color:#719e07">.</span>thing)
    <span style="color:#719e07">end</span>

    render <span style="color:#2aa198">:new</span>
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>但如果需要針對不同的 <code>Trailblazer::NotAuthorizedError</code> 情況來轉址或者是設定錯誤訊息，在只使用 <code>Trailblazer::NotAuthorizedError</code> 的情況下，變成要在 controller 端另外加判斷，例如：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">class</span> <span style="color:#268bd2">CommentsController</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationController</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">create</span>
    run <span style="color:#cb4b16">Comment</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Create</span> <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>op<span style="color:#719e07">|</span>
        flash<span style="color:#719e07">[</span><span style="color:#2aa198">:notice</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Success!&#34;</span> <span style="color:#586e75"># only run for successful/valid operation.</span>
        <span style="color:#719e07">return</span> redirect_to thing_path(@model<span style="color:#719e07">.</span>thing)
    <span style="color:#719e07">end</span>

    render <span style="color:#2aa198">:new</span>
    <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Trailblazer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">NotAuthorizedError</span>
    flash<span style="color:#719e07">[</span><span style="color:#2aa198">:alert</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;You&#39;re not Admin!&#34;</span> <span style="color:#719e07">unless</span> @user<span style="color:#719e07">.</span>admin
    flash<span style="color:#719e07">[</span><span style="color:#2aa198">:alert</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Your account is not approved!&#34;</span> <span style="color:#719e07">unless</span> @user<span style="color:#719e07">.</span>is_approved

    redirect_to root_path
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>安捏很奇怪，因為權限在 Policy 裡面判斷了一次，然後跑到 controller 裡又得再重新跑一次幾乎一樣的判斷，目前暫時的解法，是在 Policy 裡面加一個 custom error 讓 controller 統一處理需要特別關照的 <code>Trailblazer::NotAuthorizedError</code> 狀況。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#719e07">module</span> Thing
    <span style="color:#719e07">class</span> <span style="color:#268bd2">Policy</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">initialize</span>(user, thing)
        @user, @thing <span style="color:#719e07">=</span> user, thing
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">create?</span>
        <span style="color:#719e07">raise</span> <span style="color:#cb4b16">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">NotAuthorizedError</span>, <span style="color:#2aa198">&#34;You&#39;re not Admin!&#34;</span> <span style="color:#719e07">unless</span> admin?
        <span style="color:#719e07">raise</span> <span style="color:#cb4b16">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">NotAuthorizedError</span>, <span style="color:#2aa198">&#34;Your account is not approved!&#34;</span> <span style="color:#719e07">unless</span> approved?
        @thing<span style="color:#719e07">.</span>persisted?
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">private</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">admin?</span>
        @user<span style="color:#719e07">.</span>admin <span style="color:#719e07">==</span> <span style="color:#719e07">true</span>
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">def</span> <span style="color:#268bd2">approved?</span>
        @user<span style="color:#719e07">.</span>is_approved
    <span style="color:#719e07">end</span>
    <span style="color:#719e07">end</span>

    <span style="color:#719e07">class</span> <span style="color:#268bd2">NotAuthorizedError</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">StandardError</span>; <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>

<span style="color:#586e75"># in controller</span>
<span style="color:#719e07">class</span> <span style="color:#268bd2">CommentsController</span> <span style="color:#719e07">&lt;</span> <span style="color:#cb4b16">ApplicationController</span>
    <span style="color:#719e07">def</span> <span style="color:#268bd2">create</span>
    run <span style="color:#cb4b16">Comment</span><span style="color:#719e07">::</span><span style="color:#cb4b16">Create</span> <span style="color:#719e07">do</span> <span style="color:#719e07">|</span>op<span style="color:#719e07">|</span>
        flash<span style="color:#719e07">[</span><span style="color:#2aa198">:notice</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Success!&#34;</span> <span style="color:#586e75"># only run for successful/valid operation.</span>
        <span style="color:#719e07">return</span> redirect_to thing_path(@model<span style="color:#719e07">.</span>thing)
    <span style="color:#719e07">end</span>

    render <span style="color:#2aa198">:new</span>
    <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Thing</span><span style="color:#719e07">::</span><span style="color:#cb4b16">NotAuthorizedError</span> <span style="color:#719e07">=&gt;</span> e
    flash<span style="color:#719e07">[</span><span style="color:#2aa198">:alert</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> e<span style="color:#719e07">.</span>message
    redirect_to root_path
    <span style="color:#719e07">rescue</span> <span style="color:#cb4b16">Trailblazer</span><span style="color:#719e07">::</span><span style="color:#cb4b16">NotAuthorizedError</span>
    flash<span style="color:#719e07">[</span><span style="color:#2aa198">:alert</span><span style="color:#719e07">]</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Action not authorized.&#34;</span>
    redirect_to root_path
    <span style="color:#719e07">end</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>改成這樣後，雖然 controller 還是對於例外細節如何處理仍有耦合，但至少邏輯判斷不再在 Policy / Controller 裡重複，然後也能進一步將一般性的 <code>Trailblazer::NotAuthorizedError</code> 抽到 ApplicationController 裡面統一處理，對於一些複雜的例外處理需求，目前這麼做還算暫時可以接受，如果你有發現其他更好的方式，跪求指教。</p>

		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/coding">coding</a></li>
								
								<li><a href="/tags/rails">rails</a></li>
								
								<li><a href="/tags/ruby">ruby</a></li>
								
								<li><a href="/tags/trailblazer">trailblazer</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> Copyright © 2020 | Ravi Wu |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script>feather.replace()</script>
</body>
</html>
